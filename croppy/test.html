<!doctype html>
<html lang="en-us">

        <head>
                <meta charset="utf-8">
                <title>test</title>
              </head>
<body>
    hello from iframe agains
    <!-- <button onclick='generateMessage()'>Click me</button> -->
    <!-- <script type='module'> -->
    <script type='module'>

        import * as Magick from './magickApi.js';

        function generateMessage() {
            window.parent.postMessage("croppy is done!", "*")
        }


        var processesFiles = async function (files) {

            let len = files.length;
            let fileObjects = []
            //if images
            if (len > 0) {
                //clean up old images and show processing screen
                // SetProcessing(true);
                // imageHolder.innerHTML = '';

                // for each file requested split them (files isn't an array)
                let processedImagesLine = [];
                let failedProcessing = false;

                let firstFileName = files[0][0];
                let extension_first_file = firstFileName.substring(1 + firstFileName.lastIndexOf('.'))
                // DoSomeTrack("convert_start", extension_first_file, conversion_destination);


                for (let fileIndex = 0; fileIndex < files.length; ++fileIndex) {
                    let [fileName, content] = files[fileIndex];
                    let fileNameNoExt = fileName.substring(0, fileName.lastIndexOf('.'));
                    try {
                        let destFilename = fileNameNoExt + '-%d.jpg'
                        let splitFiles = await Magick.Call([{ 'name': fileName, 'content': content }],
                            ["convert", fileName, "-flatten", "-resize", "800", "-crop", "800x1280", "-quality", "100", "-scene", "0", destFilename]);
                        processedImagesLine.push(...splitFiles);
                    }
                    catch (e) {
                        if (!failedProcessing) {
                            failedProcessing = true;
                            // DoSomeTrack("convert_failed", extension_first_file, conversion_destination);

                            AlertIt("Error croppy could not format your file, old croppy may be up to the task, hit ok to go to https://old.croppy.duckdns.org", "https://old.croppy.duckdns.org");
                        }

                    }

                }
                let processedImages = processedImagesLine;
                for (let file of processedImages) {
                    let fileItem = file['blob'];
                    fileItem = fileItem.slice(0, fileItem.size, "image/jpeg");
                    fileItem.name = file['name'];
                    fileObjects.push(fileItem);
                }
            }
            window.parent.postMessage({ message: "croppy is done!", data: fileObjects }, "*");
        }

        // function receiveRequestMessage(event) {
        //     // Do we trust the sender of this message?  (might be
        //     // different from what we originally opened, for example).
        //     if (event.origin !== "http://localhost:9999") {
        //         return;
        //     }

        //     window.parent.postMessage("from_croppy: " + event.data, "*")

        // }

        // window.addEventListener('message', receiveRequestMessage, false);
        function receiveRequestMessage(event) {
            // Do we trust the sender of this message?  (might be
            // different from what we originally opened, for example).
            if (event.origin !== "http://localhost:9999") {
                return;
            }

            processesFiles(event.data);

        }
        window.addEventListener('message', receiveRequestMessage, false);
    </script>
    <script>

    </script>
</body>

</html>